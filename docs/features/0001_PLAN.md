## Plan techniczny: uproszczenie body endpointu AI i wybór modelu

Kontekst: Endpoint przetwarzania transkrypcji ma „zrezygnować z options”, a „za jego miejsce został sam customPrompt” (pole opcjonalne). „Zwracana wartość z endpointa nie ulegnie zmianie”. Dodatkowo „dodaj możliwość wyboru modelu AI w tym endponcie: 1. gemini-2.5-pro 2. gemini-2.5-flash 3. gemini-2.5-flash-lite”.

### Zakres zmian (kontrakt API)

- Wejście (body):
  - transcript: string (wymagane, niepuste)
  - purpose: `Dictionary.Purpose` (wymagane; istniejące wartości)
  - customPrompt?: string (opcjonalne, przycięte, puste traktowane jak brak)
  - model?: enum("gemini-2.5-pro", "gemini-2.5-flash", "gemini-2.5-flash-lite"). Domyślnie "gemini-2.5-pro" jeśli brak.
- Wyjście: bez zmian: `ApiResponse<AIProcessingResult>` gdzie `AIProcessingResult` zawiera: `summary?`, `topics?`, `mindMap?`, `socialPost?`, `customOutput?` (string | undefined).

### Pliki i miejsca do zmiany

- backend/src/validations/ai.validations.ts

  - Usuń `ProcessTranscriptOptionsSchema` oraz jego `.refine(...)` wymagające wyboru jednej z opcji.
  - Zmień `ProcessTranscriptRequestSchema` aby miało pola: `transcript`, `purpose`, `customPrompt?`, `model?` (enum trzech dozwolonych wartości, z domyślnym ustawieniem na "gemini-2.5-pro").
  - Zaktualizuj eksporty typów: `ProcessTranscriptRequest` (bez `options`).

- backend/src/controllers/ai.controller.ts

  - W `processTranscript(...)` zmień destrukturyzację z `{ transcript, purpose, options }` na `{ transcript, purpose, customPrompt, model }`.
  - Przekaż dalej do serwisu obiekt z nowym kształtem.

- backend/src/services/ai-processing.service.ts

  - Inicjalizacja modelu:
    - Zamiast trzymać jeden `this.model` ustawiony na stałe ("gemini-2.5-pro"), dodaj metodę pomocniczą `getModel(modelName)` zwracającą `this.genAI.getGenerativeModel({ model: modelName })`.
    - `processTranscript(request)` powinno pobrać `modelName` z requestu (z domyślną wartością z walidacji) i utworzyć instancję modelu lokalnie dla bieżącego wywołania.
  - Uproszczenie if-ów (rezygnacja z `options`):
    - `summary` i `topics` generowane zawsze.
    - `mindMap` generowane, jeśli `purpose === Dictionary.Purpose.Learning`.
    - `socialPost` generowane, jeśli `purpose === Dictionary.Purpose.SocialMedia`.
    - `customOutput` generowane, jeśli `customPrompt` jest niepuste oraz purpose === Dictionary.Purpose.Custom.
  - Interfejs metod generujących:
    - Zmienione sygnatury prywatnych metod, aby przyjmowały instancję modelu lub nazwę modelu, np. `generateSummary(transcript: string, model: GenerativeModel)` (analogicznie dla `generateTopics`, `generateMindMap`, `generateSocialPost`, `generateCustomOutput`).
  - Zachowaj istniejącą obsługę JSON w `generateMindMap` (parsowanie odpowiedzi; w przypadku błędu zwróć "{}").

- backend/src/routes/ai.routes.ts

  - Bez zmiany ścieżki. Import walidatora pozostaje, ale odnosi się do nowego `ProcessTranscriptRequestSchema` bez `options`.

- backend/src/types/ai.types.ts i backend/src/types/api.types.ts
  - Brak zmian w odpowiedziach. Upewnij się, że importy/typy nie odwołują się już do `options` (nie powinny).

### Algorytm działania po zmianach (high-level)

1. Walidacja body Zod: `{ transcript, purpose, customPrompt?, model? }`. Ustal domyślny `model = "gemini-2.5-pro"` gdy brak.
2. Utwórz instancję `GenerativeModel` dla wybranego modelu (helper `getModel(model)` w serwisie).
3. Zbuduj mapę zadań równoległych:
   - `summary`: `generateSummary(transcript, model)`
   - `topics`: `generateTopics(transcript, model)`
   - `mindMap`: jeśli `purpose === Learning` → `generateMindMap(transcript, model)`; inaczej `undefined`
   - `socialPost`: jeśli `purpose === SocialMedia` → `generateSocialPost(transcript, model)`; inaczej `undefined`
   - `customOutput`: jeśli `customPrompt` → `generateCustomOutput(transcript, customPrompt, model)`; inaczej `undefined`
4. Uruchom wszystkie obietnice równolegle, zbierz wyniki i dla każdego klucza wstaw wynik lub `undefined` (bez zmiany kształtu odpowiedzi API).

### Walidacja (Zod) – szczegóły

- `transcript`: `z.string().refine(v => v && v.trim().length > 0, { message: 'Transkrypcja nie może być pusta' })`
- `purpose`: `z.enum(Object.values(Dictionary.Purpose) as [string, ...string[]])`
- `customPrompt`: `z.preprocess(v => v === null ? undefined : v, z.string().trim().min(1).optional())` (uwaga: `min(1)` po `trim()`, aby puste traktować jak brak)
- `model`: `z.enum(['gemini-2.5-pro','gemini-2.5-flash','gemini-2.5-flash-lite']).default('gemini-2.5-pro')`
- Usuwamy `.refine(...)` powiązane z `options` (nie dotyczy już).

### Zmiany interfejsów/typów

- `ProcessTranscriptRequest` (eksportowany z `ai.validations.ts`) musi odzwierciedlać nowe pola.
- `AIProcessingService.processTranscript(request: ProcessTranscriptRequest)` – aktualizacja użycia pól.

### Testy (aktualizacje i uruchomienie)

- Zaktualizować testy „ai” używające starego body z `options`:
  - Zamienić `options.generateMindMap`/`options.generateSocialPost` na sterowanie `purpose`:
    - Dla mind map: ustaw `purpose = Learning` i nie podawaj już opcji.
    - Dla social post: ustaw `purpose = SocialMedia` i nie podawaj już opcji.
  - Dla custom output: przekaż `customPrompt` jako osobne pole.
  - Dodać przypadki wyboru modelu: jawnie przetestować wszystkie trzy wartości; dodatkowo przypadek braku `model` → domyślne "gemini-2.5-pro".
- Uruchomienie: `npm run test:ai`.

### Potencjalne ryzyka i uwagi

- Częstsza inicjalizacja modelu (na żądanie) vs. pojedyncza instancja: przy dużym ruchu warto rozważyć cache modeli w serwisie (np. `Map<modelName, GenerativeModel>`), ale nie jest to wymagane w tej zmianie.
- `generateMindMap` oczekuje JSON – upewnij się, że odpowiedni prompt gwarantuje poprawny JSON; plan nie zmienia promptów.

### Kroki implementacyjne (skrót)

1. Validation: usuń `ProcessTranscriptOptionsSchema`, zmień `ProcessTranscriptRequestSchema`, zaktualizuj typy.
2. Controller: zmień destrukturyzację body i wywołanie serwisu.
3. Service: dodaj wybór modelu, uprość warunki, popraw sygnatury `generate*` aby używały wybranego modelu.
4. Trasa: bez zmian poza importem zaktualizowanego schematu (ścieżka bez zmian).
5. Testy: zaktualizuj fixtury/wywołania; uruchom `npm run test:ai`.
